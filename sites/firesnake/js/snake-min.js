function extractNumber(g){var d=g.length;var f="";var c=[0,1,2,3,4,5,6,7,8,9];var e=c.length;var a=true;for(var b=0;b<d;b++){for(var h=0;h<e;h++){if(g[b]==c[h]){f+=g[b];continue}}if(g[b]=="."&&a){f+=g[b];a=false}else{break}}if(g[g.length-1]=="."){g+="0"}return parseFloat(g)}function iterateObject(c,b){var d="";for(var a in c){d+=a+": "+c[a]+"\n"}b(d)}var IdGenerator=new function(){var a=0;this.generate=function(){if(a==Number.MAX_VALUE){a=0}return a++}};function OnBorderCollapseEvent(a,c,b){this.border=a;this.cols=c;this.rows=b}function OnSnakeTouchEvent(a){this.snake=a}function PositionEntity(b){this.pos=[];this.id=IdGenerator.generate();var c=this;for(var a=0;a<b.length;a++){this.pos.push(b[a])}this.getX=function(){return c.pos[0]};this.getY=function(){return c.pos[1]}}function MotionEntity(a,d,c){this.direction=d;this.speed=c;this.prevPos=[];var b=this;PositionEntity.call(this,a);this.savePrevPos=function(){b.prevPos=[];for(var e=0;e<b.pos.length;e++){b.prevPos.push(b.pos[e])}};this.getPrevX=function(){return b.prevPos[0]};this.getPrevY=function(){return b.prevPos[1]};this.getNextPointByDirection=function(){var e=pos.slice();switch(b.direction){case Direction.LEFT:e[0]-=b.speed;break;case Direction.RIGHT:e[0]+=b.speed;break;case Direction.TOP:e[1]-=b.speed;break;case Direction.BOTTOM:e[1]+=b.speed;break}return e}}function AliveEntity(b,e,d,a){var a=a;var c=a;MotionEntity.call(this,b,e,d);this.changeLiveValue=function(f){if(f>0&&a+f<=c||f<0&&a+f>=0){a+=f}};this.getLiveValue=function(){return a};this.setLiveValue=function(f){a=f;c=f}}function PoweredEntity(a){this.power=a}var WaiterState={FREE:0,BUSY:1};function WaitingObjectManager(){var a=[];this.waitAll=function(){for(var c=0;c<a.length;c++){a[c].wait()}};this.newWaiting=function(h,j,c,d,e){var g=null;for(var f=0;f<a.length;f++){if(a[f].getState()==WaiterState.FREE){g=a[f];break}}if(g==null){g=new b();a.push(g)}g.init(h,j,c,d,e)};var b=function(){var f;var h;var c;var d;var e;var i=WaiterState.FREE;var g=0;var j=false;this.init=function(m,k,o,n,l){if(j){return}f=m;h=k;c=o>>0;d=n>>0;e=l;j=true};this.wait=function(){if(!j){return}if(i==WaiterState.FREE){g=(c+(d-c)*Math.random())>>0;i=WaiterState.BUSY}if(g>0){g--;if(g==0){h.apply(f,e);i=WaiterState.FREE;j=false}}};this.getState=function(){return i}}}var FruiteType={FRUITE:1,MEDICINE:2};var Direction={NONE:0,LEFT:1,RIGHT:7,TOP:3,BOTTOM:5,getValue:function(){return 8},getInverse:function(a){switch(a){case this.LEFT:return this.RIGHT;case this.RIGHT:return this.LEFT;case this.TOP:return this.BOTTOM;case this.BOTTOM:return this.TOP}},getRandomDirection:function(){var b=Math.random();var a;if(b<=0.25){a=this.LEFT}else{if(b<=0.5){a=this.TOP}else{if(b<=0.75){a=this.RIGHT}else{a=this.BOTTOM}}}return a}};var CellType={EMPTY:0,SNAKE:1,FRUITE:2,OPPONENT:3,BULLET:4,MEDICINE:5};function Matrix(b,f,e,a,g,d){var c=this;this.setCell=function(i,l,k){if(l>e||l<1||i>f||i<1){return}var j=(i-1)*a+g;var h=(l-1)*a+d;b.drawImage(k,j,h)};this.setCellScale=function(h,p,i,m,k,o,j){if(p>e||p<1||h>f||h<1){return}var n=(h-1)*a+g;var l=(p-1)*a+d;b.drawImageScale(i,m,k,o,j,n,l,a,a)};this.clear=function(){b.clearRect(g,d,f*a,e*a)};this.isCellInside=function(h,i){return i<=e&&i>=1&&h<=f&&h>=1}}function Fruite(a,e,d,c,b){PositionEntity.call(this,[a,e]);PoweredEntity.call(this,c);this.kind=b;this.type=d}var AnimationType={OPPONENT_EXPLOSION:0};function AnimatedCell(a,d,b,c){PositionEntity.call(this,[a,d]);this.type=c;this.liveValue=b}function Snake(a,f,e,d,b){switch(e){case Direction.LEFT:AliveEntity.call(this,[[a,f],[a+1,f],[a+2,f]],e,d,b);break;case Direction.RIGHT:AliveEntity.call(this,[[a,f],[a-1,f],[a-2,f]],e,d,b);break;case Direction.TOP:AliveEntity.call(this,[[a,f],[a,f+1],[a,f+2]],e,d,b);break;case Direction.BOTTOM:AliveEntity.call(this,[[a,f],[a,f-1],[a,f-2]],e,d,b);break}this.alive=true;var c=this;this.setDefault=function(){c.pos=[[a,f]];c.alive=true;c.direction=e;c.liveValue=b};this.move=function(){var h=c.pos[0].slice();switch(c.direction){case Direction.LEFT:h[0]-=c.speed;break;case Direction.RIGHT:h[0]+=c.speed;break;case Direction.TOP:h[1]-=c.speed;break;case Direction.BOTTOM:h[1]+=c.speed;break}c.pos.unshift(h);for(var g=1;g<c.pos.length;g++){if(h[0]==c.pos[g][0]&&h[1]==c.pos[g][1]){c.alive=false;return}}};this.deleteTail=function(){c.pos.pop()};this.getHead=function(){return c.pos[0]};this.getTail=function(){return c.pos[c.pos.length-1]};this.isTouch=function(g,k){var h=false;for(var j=0;j<c.pos.length;j++){if(g==c.pos[j][0]&&k==c.pos[j][1]){h=true}}return h};this.getNextPointByDirection=function(){var g=c.getHead().slice();switch(c.direction){case Direction.LEFT:g[0]-=c.speed;break;case Direction.RIGHT:g[0]+=c.speed;break;case Direction.TOP:g[1]-=c.speed;break;case Direction.BOTTOM:g[1]+=c.speed;break}return g}}var OpponentIntellect={STANDART:0,NEAR_DETECTING:1};function Opponent(j,g,d,h,c,b,i,f,a){AliveEntity.call(this,[j,g],h,c,d);PoweredEntity.call(this,a);this.snake=i;this.interval=b;this.intellect=f;var k=0;var e=this;this.move=function(l){if(l){if(k==e.interval){e.direction=Direction.getRandomDirection();k=0}else{k++}}e.think();switch(e.direction){case Direction.LEFT:e.pos[0]-=e.speed;break;case Direction.RIGHT:e.pos[0]+=e.speed;break;case Direction.TOP:e.pos[1]-=e.speed;break;case Direction.BOTTOM:e.pos[1]+=e.speed;break}};this.onBorderCollapse=function(l){e.direction=Direction.getInverse(e.direction);k=0};this.setDefault=function(){e.pos=[j,g];e.liveValue=d;e.direction=h;e.ticks=0};this.think=function(){if(e.intellect==OpponentIntellect.NEAR_DETECTING){for(var l=0;l<i.pos.length;l++){if(i.pos[l][0]==e.pos[0]-1&&i.pos[l][1]==e.pos[1]-1||i.pos[l][0]==e.pos[0]&&i.pos[l][1]==e.pos[1]-1||i.pos[l][0]==e.pos[0]+1&&i.pos[l][1]==e.pos[1]-1){e.direction=Direction.TOP;break}else{if(i.pos[l][0]==e.pos[0]-1&&i.pos[l][1]==e.pos[1]+1||i.pos[l][0]==e.pos[0]&&i.pos[l][1]==e.pos[1]+1||i.pos[l][0]==e.pos[0]+1&&i.pos[l][1]==e.pos[1]+1){e.direction=Direction.BOTTOM;break}else{if(i.pos[l][0]==e.pos[0]-1&&i.pos[l][1]==e.pos[1]){e.direction=Direction.LEFT;break}else{if(i.pos[l][0]==e.pos[0]+1&&i.pos[l][1]==e.pos[1]){e.direction=Direction.RIGHT;break}}}}}}}}function Bullet(a,g,d,f,e,b){MotionEntity.call(this,[a,g],f,e);PoweredEntity.call(this,b);this.entityToFire=d;var c=this;this.move=function(){c.savePrevPos();switch(c.direction){case Direction.LEFT:c.pos[0]-=c.speed;break;case Direction.RIGHT:c.pos[0]+=c.speed;break;case Direction.TOP:c.pos[1]-=c.speed;break;case Direction.BOTTOM:c.pos[1]+=c.speed;break}}}var config={volume:0.1,cellSize:20,imgCellSize:20,cols:30,rows:20,snakeSpeed:1,opponentSpeed:1,bulletSpeed:1,opponentInterval:15,fruitsCount:11,canvasWidth:600,canvasHeight:450,snakeLiveValue:30,gameFrequency:50};function Drawer(a,j,g){var d=document.getElementById(a);var c=d.getContext("2d");var h=document.createElement("canvas");var e=h.getContext("2d");var f=document.createElement("canvas");var b=f.getContext("2d");var i=this;h.width=j;h.height=g;this.fillRect=function(k,o,l,n,m){e.fillStyle=m;e.fillRect(k,o,l,n)};this.drawRect=function(l,p,m,o,n,k){e.strokeStyle=n;e.lineWidth=k;e.strokeRect(l,p,m,o)};this.clearRect=function(k,n,l,m){};this.fillText=function(n,k,o,m,l){e.fillStyle=m;e.font=l;e.fillText(n,k,o)};this.measureText=function(m,k){var n=e.font;e.font=k;var l=e.measureText(m);e.font=n;return l};this.drawImage=function(l,k,m){e.drawImage(l,k,m)};this.drawImageScale=function(l,p,o,q,m,s,r,k,n){e.drawImage(l,p,o,q,m,s,r,k,n)};this.copy=function(p,o,k,n,m,l){f.width=k*m>>0;f.height=n*l>>0;b.scale(m,l);b.drawImage(h,p,o,k,n,0,0,k,n)};this.paste=function(k,m,l){e.rotate(l*Math.PI/180);e.drawImage(f,k,m);e.rotate(-l*Math.PI/180)};this.show=function(){c.drawImage(h,0,0)}}function AnimationManager(d){var e={};var b={};var d=d;this.draw=function(g,f,h){if(g in b){b[g]=true;e[g].draw(f,h);return true}a();return false};this.movePlaybackHead=function(g,i,h,f){if(g in b){e[g].movePlaybackHead(i,h,f);return true}return false};this.getFrameNumber=function(f){if(f in b){return e[f].getFrameNumber()}return -1};this.animatorExists=function(f){return f in b};this.addAnimator=function(m,g,l,h,k,f,j,i){e[m]=new c(g,l,h,k,f,j,i);b[m]=false;a()};this.free=function(){a();for(var f in b){if(!b[f]){delete b[f];delete e[f]}else{b[f]=false}}a()};function a(){}function c(g,l,h,k,f,j,i){var g=g;var l=l;var h=h;var k=k;var i=i;var m=f-1;this.draw=function(n,q){if(i==0){return}m++;if(m==j+1){if(l){m=f}else{m--}}var p=m*h;var o=0;d.setCellScale(n,q,g,p,o,h,k)};this.movePlaybackHead=function(p,o,n){if(p>=0&&p<=n&&o>=0&&n<i&&o>=0&&n<i){m=p-1;f=o;j=n}};this.getFrameNumber=function(){if(m<0){return 0}return m}}}var SnakeCellType={NONE:-1,TO_LEFT:0,TO_RIGHT:1,TO_TOP:2,TO_BOTTOM:3,HEAD_TOP:4,HEAD_BOTTOM:5,HEAD_LEFT:6,HEAD_RIGHT:7,TAIL_TOP:8,TAIL_BOTTOM:9,TAIL_LEFT:11,TAIL_RIGHT:10,LEFT_TO_TOP:12,LEFT_TO_BOTTOM:13,TOP_TO_LEFT:14,BOTTOM_TO_LEFT:15,RIGHT_TO_TOP:16,RIGHT_TO_BOTTOM:17,TOP_TO_RIGHT:18,BOTTOM_TO_RIGHT:19};var OpponentFrameSet={};OpponentFrameSet[Direction.LEFT]=[0,5];OpponentFrameSet[Direction.RIGHT]=[6,11];OpponentFrameSet[Direction.TOP]=[12,17];OpponentFrameSet[Direction.BOTTOM]=[18,23];function Graphics(a,h,k,b){this.LIGHT_GREEN_COLOR="#8ec63f";this.GREEN_COLOR="#3ab54a";this.DARK_GREEN_COLOR="#319b3f";this.RED_COLOR="#ed1b24";this.BLACK_COLOR="#000";var c=new Drawer(a,h*b,k*b+50);var i=new Matrix(c,h,k,b,0,50);var d=new AnimationManager(i);var g={};var h=h;var k=k;var e="15pt Arial,sans-serif";var f=this;g.BACKGD=new Image();g.BACKGD.src="img/backgd.jpg";g.SNAKE=new Image();g.SNAKE.src="img/snake.png";g.FRUITE=new Image();g.FRUITE.src="img/fruite.png";g.MEDICINE=new Image();g.MEDICINE.src="img/medicine.png";g.OPPONENT=new Image();g.OPPONENT.src="img/opponent.png";g.OPPONENT_NEARDETECTING=new Image();g.OPPONENT_NEARDETECTING.src="img/opponent_nd.png";g.BULLET=new Image();g.BULLET.src="img/bullet.png";g.EXPLOSION=new Image();g.EXPLOSION.src="img/explosion.png";g.START=new Image();g.START.src="img/start.png";g.WIN=new Image();g.WIN.src="img/win.png";this.drawSnake=function(n){var l=0;for(var m=0;m<n.pos.length;m++){l=j(n,m);if(l!=SnakeCellType.NONE){i.setCellScale(n.pos[m][0],n.pos[m][1],g.SNAKE,l*config.imgCellSize,0,config.imgCellSize,config.imgCellSize)}}};this.drawOpponent=function(m){if(!d.animatorExists(m.id)){switch(m.intellect){case OpponentIntellect.STANDART:d.addAnimator(m.id,g.OPPONENT,true,config.imgCellSize,config.imgCellSize,0,0,24);break;case OpponentIntellect.NEAR_DETECTING:d.addAnimator(m.id,g.OPPONENT_NEARDETECTING,true,config.imgCellSize,config.imgCellSize,0,0,24);break}}var p=d.getFrameNumber(m.id);var r;for(var n in OpponentFrameSet){if(p>=OpponentFrameSet[n][0]&&p<=OpponentFrameSet[n][1]){r=n}}if(r!=m.direction){var o=OpponentFrameSet[m.direction][0];var l=OpponentFrameSet[m.direction][1];var q=o+p-OpponentFrameSet[r][0];d.movePlaybackHead(m.id,q,o,l)}d.draw(m.id,m.getX(),m.getY())};this.drawFruite=function(l){switch(l.type){case FruiteType.FRUITE:i.setCellScale(l.pos[0],l.pos[1],g.FRUITE,l.kind*config.imgCellSize,0,config.imgCellSize,config.imgCellSize);break;case FruiteType.MEDICINE:i.setCellScale(l.pos[0],l.pos[1],g.MEDICINE,0,0,config.imgCellSize,config.imgCellSize);break}};this.drawBullet=function(l){var m=-1;switch(l.direction){case Direction.LEFT:m=0;break;case Direction.RIGHT:m=1;break;case Direction.TOP:m=2;break;case Direction.BOTTOM:m=3}if(m!=-1){i.setCellScale(l.pos[0],l.pos[1],g.BULLET,m*config.imgCellSize,0,config.imgCellSize,config.imgCellSize)}};this.drawAnimatedCell=function(l){if(!d.animatorExists(l.id)){switch(l.type){case AnimationType.OPPONENT_EXPLOSION:d.addAnimator(l.id,g.EXPLOSION,false,config.imgCellSize,config.imgCellSize,0,8,9);break}}d.draw(l.id,l.getX(),l.getY())};this.drawMatrix=function(o,n){f.drawImage(g.BACKGD,0,50);f.fillRect(0,0,f.getCanvasWidth(),50,f.DARK_GREEN_COLOR);f.fillText("жизнь:",20,30,f.BLACK_COLOR,e);f.drawRect(90,10,380,30,f.BLACK_COLOR,1);f.fillRect(90,10,380,30,f.RED_COLOR);var m=Math.floor(290/config.snakeLiveValue);if(o>=config.snakeLiveValue){var l=380}else{var l=90+o*m}f.fillRect(90,10,l,30,f.LIGHT_GREEN_COLOR);f.fillText("очки: ",485,30,f.BLACK_COLOR,e);f.fillText(n,535,30,"#f00",e)};this.drawStartImage=function(l,m){f.drawImage(g.START,l,m)};this.drawWinImage=function(l,m){f.drawImage(g.WIN,l,m)};this.getColCount=function(){return h};this.getRowCount=function(){return k};this.getCanvasWidth=function(){return config.canvasWidth};this.getCanvasHeight=function(){return config.canvasHeight};this.isCellInside=function(l,m){return i.isCellInside(l,m)};this.fillRect=function(l,p,m,o,n){c.fillRect(l,p,m,o,n)};this.drawRect=function(m,q,n,p,o,l){c.drawRect(m,q,n,p,o,l)};this.fillText=function(o,l,p,n,m){c.fillText(o,l,p,n,m)};this.measureText=function(m,l){return c.measureText(m,l)};this.drawImage=function(m,l,n){c.drawImage(m,l,n)};this.drawImageScale=function(m,q,p,r,n,t,s,l,o){c.drawImageScale(m,q,p,r,n,t,s,l,o)};this.copy=function(s,r,m,q,p,o,n,l){c.drawRect(s,r,m,q,n,l);c.copy(s,r,m,q,p,o)};this.paste=function(l,n,m){c.paste(l,n,m)};this.show=function(){c.show();d.free()};function j(r,o){if(o==0){switch(r.direction){case Direction.LEFT:return SnakeCellType.HEAD_LEFT;case Direction.RIGHT:return SnakeCellType.HEAD_RIGHT;case Direction.TOP:return SnakeCellType.HEAD_TOP;case Direction.BOTTOM:return SnakeCellType.HEAD_BOTTOM}}else{if(o==r.pos.length-1){if(r.pos[o][0]==r.pos[o-1][0]&&r.pos[o][1]<r.pos[o-1][1]){return SnakeCellType.TAIL_BOTTOM}else{if(r.pos[o][0]==r.pos[o-1][0]&&r.pos[o][1]>r.pos[o-1][1]){return SnakeCellType.TAIL_TOP}else{if(r.pos[o][1]==r.pos[o-1][1]&&r.pos[o][0]<r.pos[o-1][0]){return SnakeCellType.TAIL_RIGHT}else{return SnakeCellType.TAIL_LEFT}}}}else{if((r.pos[o][0]==r.pos[o-1][0]&&r.pos[o][0]==r.pos[o+1][0])||(r.pos[o][1]==r.pos[o-1][1]&&r.pos[o][1]==r.pos[o+1][1])){if(r.pos[o][0]==r.pos[o-1][0]&&r.pos[o][0]==r.pos[o+1][0]){if(r.pos[o][1]<r.pos[o-1][1]){return SnakeCellType.TO_BOTTOM}else{return SnakeCellType.TO_TOP}}else{if(r.pos[o][0]<r.pos[o-1][0]){return SnakeCellType.TO_RIGHT}else{return SnakeCellType.TO_LEFT}}}else{var n=r.pos[o][0];var t=r.pos[o][1];var m=r.pos[o-1][0];var s=r.pos[o-1][1];var l=r.pos[o+1][0];var q=r.pos[o+1][1];var p="";if(m==n&&s==t-1){p+="t1"}else{if(l==n&&q==t-1){p+="t2"}else{if(m==n&&s==t+1){p+="b1"}else{if(l==n&&q==t+1){p+="b2"}}}}if(m==n-1&&s==t){p+="l1"}else{if(l==n-1&&q==t){p+="l2"}else{if(m==n+1&&s==t){p+="r1"}else{if(l==n+1&&q==t){p+="r2"}}}}switch(p){case"t1l2":return SnakeCellType.RIGHT_TO_TOP;case"t2l1":return SnakeCellType.BOTTOM_TO_LEFT;case"t1r2":return SnakeCellType.LEFT_TO_TOP;case"t2r1":return SnakeCellType.BOTTOM_TO_RIGHT;case"b1l2":return SnakeCellType.RIGHT_TO_BOTTOM;case"b2l1":return SnakeCellType.TOP_TO_LEFT;case"b1r2":return SnakeCellType.LEFT_TO_BOTTOM;case"b2r1":return SnakeCellType.TOP_TO_RIGHT}}}}return SnakeCellType.NONE}}function SnakeGame(a,c,b,d){this.g=new Graphics(a,c,b,d);this.input=new InputManager();this.audio=new AudioManager();this.screen=new StartScreen(this,StartScreenType.FIRST);this.pointCount=0}var InputEventType={KEYBOARD:0,MOUSE_CLICK:1,MOUSE_MOVE:2};function InputEvent(b,a,d,c){this.key=b;this.x=a;this.y=d;this.type=c}function InputManager(){var d=undefined;var a=false;var c;var b;this.getDirection=function(){var e=d;d=undefined;return e};this.getMouseClick=function(){var e=c;c=undefined;return e};this.getMouseMove=function(){var e=b;b=undefined;return e};this.getFire=function(){var e=a;a=false;return e};this.setEvent=function(e){if(e.type==InputEventType.KEYBOARD){if(d==undefined){switch(e.key){case 37:d=Direction.LEFT;break;case 38:d=Direction.TOP;break;case 39:d=Direction.RIGHT;break;case 40:d=Direction.BOTTOM;break;case 32:a=true;break}}}else{if(e.type=InputEventType.MOUSE_CLICK){c=e}else{if(e.type=InputEventType.MOUSE_CLICK){b=e}}}}}function AudioPool(f,d,c){var b=[];var g=[];var f=f;var d=d;var c=c;for(var a=0;a<d;a++){e(true)}this.play=function(){for(var h=0;h<b.length;h++){if(b[h].ended||g[h]){b[h].play();g[h]=false;return}}var j=e(false);j.play()};function e(i){var h=new Audio(f);h.loop=false;h.autoplay=false;h.volume=c;b.push(h);g.push(i);return h}}function AudioTrack(d,b,c){var a=null;if(b!=null){a=new AudioPool(d+b,c,config.volume)}this.play=function(){if(a!=null){a.play()}}}function AudioManager(){var d=new Audio("");var a=!!d.canPlayType&&d.canPlayType("audio/ogg")!="";var b=!!d.canPlayType&&d.canPlayType("audio/mp3")!="";var c=null;if(b){c=".mp3"}else{if(a){c=".ogg"}}this.eat=new AudioTrack("sound/eat",c,10);this.fire=new AudioTrack("sound/fire",c,10);this.opponentExplosion=new AudioTrack("sound/explosion",c,2);this.opponentPreexplosion=new AudioTrack("sound/preexplosion",c,2);this.gameWin=new AudioTrack("sound/gamewin",c,1);this.gameOver=new AudioTrack("sound/gameover",c,1);this.btnClick=new AudioTrack("sound/fire",c,1)}var ControlState={STATE_UP:0,STATE_DOWN:1,STATE_OVER:2};function Control(f,e,a,b,d){this.left=f;this.top=e;this.width=a;this.height=b;this.state=d;var c=this;this.isInside=function(g,h){return g>=c.left&&h>=c.top&&g<c.left+c.width&&h<c.top+c.height}}function LevelManager(a){var e=[];var c=0;var d=this;e.push(new b(1,10,1,1,OpponentIntellect.STANDART,1,400,500,-1,1,1,600,1200,-1));e.push(new b(2,20,1,1,OpponentIntellect.STANDART,1,400,500,-1,1,1,600,1200,-1));e.push(new b(3,30,2,1,OpponentIntellect.STANDART,2,400,500,-1,1,2,600,1200,-1));e.push(new b(4,50,2,2,OpponentIntellect.STANDART,3,300,400,-1,1,2,600,800,-1));e.push(new b(5,80,3,2,OpponentIntellect.NEAR_DETECTING,5,200,300,-2,1,3,300,500,-1));e.push(new b(6,90,3,2,OpponentIntellect.NEAR_DETECTING,5,200,300,-2,1,3,300,500,-1));e.push(new b(7,100,3,3,OpponentIntellect.NEAR_DETECTING,5,200,300,-2,1,3,300,500,-1));this.getLevel=function(){return e[c]};this.verifyLevel=function(f){if(d.getLevel().isLevelEnd(f)){c++;if(c==2||c==4){a.newFruite(FruiteType.FRUITE,1)}if(c==3){a.newOpponent()}}return c==e.length};function b(i,l,j,q,r,p,h,t,k,s,g,o,m,f){this.levelNumber=i;this.pointsLimit=l;this.fruiteCount=j;this.opponentCount=q;this.opponentIntellect=r;this.opponentLiveValue=p;this.opponentShowLeftBorder=h;this.opponentShowRightBorder=t;this.opponentPower=k;this.foodPower=s;this.medicinePower=g;this.medicineShowLeftBorder=o;this.medicineShowRightBorder=m;this.bulletPower=f;var n=this;this.isLevelEnd=function(u){return n.pointsLimit<=u}}}var StartScreenType={FIRST:0,GAME_OVER:1,WIN:2};function StartScreen(b,d){var b=b;var e=new Control(150,300,300,100,ControlState.STATE_UP);var f="Arial,sans-serif";this.update=function(){var g=b.input.getMouseClick();if(g!=undefined){if(e.isInside(g.x,g.y)){a(g)}}};this.present=function(){if(d==StartScreenType.FIRST){b.g.fillRect(0,0,b.g.getCanvasWidth(),b.g.getCanvasHeight(),b.g.GREEN_COLOR);b.g.drawStartImage(0,50);c("Начать игру")}else{if(d==StartScreenType.GAME_OVER){b.g.fillRect(0,0,b.g.getCanvasWidth(),b.g.getCanvasHeight(),b.g.GREEN_COLOR);c("Начать заново");b.g.paste(-50,80,-20);b.g.fillText("Очки:",400,70,b.g.BLACK_COLOR,"30px "+f);b.g.fillText(b.pointCount,400,110,b.g.RED_COLOR,"35px "+f)}else{b.g.fillRect(0,0,b.g.getCanvasWidth(),b.g.getCanvasHeight(),b.g.GREEN_COLOR);b.g.drawWinImage(100,100);c("Начать игру")}}b.g.show()};function c(g){var i=(e.left+e.width/2)-b.g.measureText(g,"40px "+f).width/2;var h=(e.top+e.height/2)+10;b.g.drawRect(e.left,e.top,e.width,e.height,b.g.DARK_GREEN_COLOR,4);b.g.fillRect(e.left,e.top,e.width,e.height,b.g.LIGHT_GREEN_COLOR);b.g.fillText(g,i,h,b.g.BLACK_COLOR,"40px "+f)}function a(g){b.screen=new GameScreen(b,20);firstScreen=false}}function GameScreen(p){var p=p;var n=new Snake(Math.floor(p.g.getColCount()/2),Math.floor(p.g.getRowCount()/2),Direction.getRandomDirection(),config.snakeSpeed,config.snakeLiveValue);var m=[];var h=[];var d=[];var a=[];var e=false;var g=config.opponentSpeed;var c=config.bulletSpeed;var o=false;var f=new WaitingObjectManager();var l=new LevelManager(this);var k=true;var b=n.direction;var i=this;this.init=function(){p.pointCount=0;p.g.drawMatrix(n.liveValue,p.pointCount);i.newOpponent();i.newFruite(FruiteType.FRUITE,l.getLevel().foodPower);i.newFruite(FruiteType.MEDICINE,l.getLevel().medicinePower);p.g.drawFruite(m[0]);p.g.drawFruite(m[1]);p.g.drawSnake(n);p.g.drawOpponent(h[0])};this.update=function(){if(!e){var q=p.input.getDirection();if(q!=undefined){if(b+q!=Direction.getValue()&&b!=q){n.direction=q;b=q}}}if(!e){for(var t=0;t<h.length;t++){if(h[t].getX()==1||h[t].getX()==p.g.getColCount()||h[t].getY()==1||h[t].getY()==p.g.getRowCount()){var r=Direction.NONE;if(h[t].getX()==1&&h[t].direction==Direction.LEFT){r=Direction.LEFT}else{if(h[t].getX()==p.g.getColCount()&&h[t].direction==Direction.RIGHT){r=Direction.RIGHT}else{if(h[t].getY()==1&&h[t].direction==Direction.TOP){r=Direction.TOP}else{if(h[t].getY()==p.g.getRowCount()&&h[t].direction==Direction.BOTTOM){r=Direction.BOTTOM}}}}if(r!=Direction.NONE){h[t].onBorderCollapse(new OnBorderCollapseEvent(r,p.g.getColCount(),p.g.getRowCount()))}h[t].move(false)}else{h[t].move(true)}}}for(var t=0;t<d.length;t++){d[t].move()}f.waitAll();if(p.input.getFire()){i.snakeFire()}for(var t=0;t<a.length;t++){a[t].liveValue--;if(a[t].liveValue==0){a.splice(t,1)}}if(l.verifyLevel(p.pointCount)){p.screen=new StartScreen(p,StartScreenType.WIN);p.audio.gameWin.play();$(document).trigger("onGameOver");return}if(!e){n.move();var s=n.getHead();for(var t=0;t<h.length;t++){if(n.isTouch(h[t].getX(),h[t].getY())){n.changeLiveValue(h[t].power);if(n.getLiveValue()==0){n.alive=false}}}if(!p.g.isCellInside(s[0],s[1])){n.alive=false}if(!n.alive){p.screen=new StartScreen(p,StartScreenType.GAME_OVER);p.audio.gameOver.play();p.g.copy(0,50,config.canvasWidth,config.canvasHeight-50,0.5,0.5,p.g.DARK_GREEN_COLOR,4);$(document).trigger("onGameOver");return}}for(var t=0;t<d.length;t++){if(d[t].entityToFire!=CellType.OPPONENT){continue}for(var u=0;u<h.length;u++){if(d[t].getX()==h[u].getX()&&d[t].getY()==h[u].getY()||d[t].getPrevX()==h[u].getX()&&d[t].getPrevY()==h[u].getY()){h[u].changeLiveValue(d[t].power);d.splice(t,1);if(h[u].getLiveValue()==0){i.newAnimatedCell(h[u].getX(),h[u].getY(),3,AnimationType.OPPONENT_EXPLOSION);h.splice(u,1);f.newWaiting(this,i.newOpponent,l.getLevel().opponentShowLeftBorder,l.getLevel().opponentShowRightBorder,[]);p.audio.opponentExplosion.play()}else{p.audio.opponentPreexplosion.play()}}}}for(var t=0;t<d.length;t++){if(!p.g.isCellInside(d[t].getX(),d[t].getY())){d.splice(t,1)}}if(!e){o=false;for(var t=0;t<m.length;t++){if(s[0]==m[t].getX()&&s[1]==m[t].getY()){if(m[t].type==FruiteType.FRUITE){o=true;p.pointCount+=m[t].power;m.splice(t,1);i.newFruite(FruiteType.FRUITE,l.getLevel().foodPower);p.audio.eat.play()}else{if(m[t].type==FruiteType.MEDICINE){n.changeLiveValue(m[t].power);m.splice(t,1);f.newWaiting(this,i.newFruite,l.getLevel().medicineShowLeftBorder,l.getLevel().medicineShowRightBorder,[FruiteType.MEDICINE,l.getLevel().medicinePower]);p.audio.eat.play()}}break}}if(!o){n.deleteTail()}}e=!e};this.present=function(){p.g.drawMatrix(n.getLiveValue(),p.pointCount);for(var q=0;q<a.length;q++){p.g.drawAnimatedCell(a[q])}for(var q=0;q<m.length;q++){p.g.drawFruite(m[q])}p.g.drawSnake(n);for(var q=0;q<h.length;q++){p.g.drawOpponent(h[q])}for(var q=0;q<d.length;q++){p.g.drawBullet(d[q])}p.g.show()};this.snakeFire=function(){if(n.pos.length>3){var q=n.getNextPointByDirection();d.push(new Bullet(q[0],q[1],CellType.OPPONENT,n.direction,c,l.getLevel().bulletPower));n.deleteTail();p.audio.fire.play()}};this.getFreeCell=function(u,s){var r=false;var q,v;while(true){q=((Math.random()*(p.g.getColCount()-1))>>0)+1;v=((Math.random()*(p.g.getRowCount()-1))>>0)+1;if(u){for(var t=0;t<n.pos.length;t++){if(n.pos[t][0]==q&&n.pos[t][1]==v){r=true;break}}}for(var t=0;t<m.length;t++){if(m[t].getX()==q&&m[t].getY()==v){r=true;break}}if(r){r=false}else{return[q,v]}}};this.newFruite=function(r,q){var s=i.getFreeCell(true,false);m.push(new Fruite(s[0],s[1],r,q,j(config.fruitsCount)))};this.newOpponent=function(){var q=i.getFreeCell(true,true);h.push(new Opponent(q[0],q[1],l.getLevel().opponentLiveValue,Direction.getRandomDirection(),g,config.opponentInterval,n,l.getLevel().opponentIntellect,l.getLevel().opponentPower))};this.newAnimatedCell=function(q,t,r,s){a.push(new AnimatedCell(q,t,r,s))};function j(r){var q=Math.random();return q*r>>0}i.init()}function SnakeGameCore(b,g,e,h,d){var f=d;var a=new SnakeGame(b,g,e,h);var c=this;this.run=function(){var j=setInterval(i,d);function i(){a.screen.update();a.screen.present()}};this.setInput=function(i){a.input.setEvent(i)};this.getPointCount=function(){return a.pointCount}}$(document).ready(function(){var a=null;$(document).keydown(function(g){var d=g||window.event;var f=d.keyCode||d.which;g.preventDefault();a.setInput(new InputEvent(f,0,0,InputEventType.KEYBOARD))});$(document).on("keydown","#login",{},function(d){d.stopPropagation()});$(document).on("keydown","#password",{},function(d){d.stopPropagation()});$("#canvas2d").mouseup(function(g){var f=document.getElementById("canvas2d");var d=g.pageX-f.offsetLeft;var h=g.pageY-f.offsetTop;a.setInput(new InputEvent(0,d,h,InputEventType.MOUSE_CLICK))});function c(d){$.ajax({url:"asyncHandler.php",dataType:"html",type:"POST",data:d,beforeSend:function(){document.body.style.cursor="wait";$("#login").css("cursor","wait");$("#loginBtn").css("cursor","wait");$("#password").css("cursor","wait");$("#passwordBtn").css("cursor","wait");$("#registerBtn").css("cursor","wait");$("#logoutBtn").css("cursor","wait")},success:function(e,f){$("#contentBlock").html(e);document.body.style.cursor="default";$("#login").css("cursor","default");$("#loginBtn").css("cursor","default");$("#password").css("cursor","default");$("#passwordBtn").css("cursor","default");$("#registerBtn").css("cursor","default");$("#logoutBtn").css("cursor","default")}})}$(document).on("click","#loginBtn",{},function(){c({login:$("#login").val(),password:$("#password").val(),loginBtn:""})});$(document).on("click","#registerBtn",{},function(){c({login:$("#login").val(),password:$("#password").val(),registerBtn:""})});$(document).on("click","#logoutBtn",{},function(){c({logoutBtn:""})});$(document).ajaxError(function(h,f,g,d){alert("Произошла ошибка при выполнении асинхронного запроса: "+d)});$(document).bind("onGameOver",function(){$.ajax({url:"add.php",dataType:"json",type:"POST",data:{score:a.getPointCount()},success:function(d,e){if(d.result){$("#contentBlock").html(d.content)}}})});function b(){a=new SnakeGameCore("canvas2d",config.cols,config.rows,config.cellSize,config.gameFrequency);a.run()}b()});